deploy:
  name: Deploy (CD)
  needs: backend-ci
  runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Ansible
      run: |
        sudo apt update
        sudo apt install -y ansible

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AZURE_SSH_KEY }}" > ~/.ssh/azure-cd
        chmod 600 ~/.ssh/azure-cd
        ssh-keyscan -H <AZURE_PUBLIC_IP> >> ~/.ssh/known_hosts

    - name: Deploy using Ansible
      working-directory: multi-stage-multi-agent
      run: |
        ansible-playbook -i ansible/inventory ansible/deploy.yml
