- name: Deploy HelloWorld app (Versioned with current symlink)
  hosts: app
  become: yes

  vars:
    app_base: /opt/hello
    releases_dir: "{{ app_base }}/releases"
    current_path: "{{ app_base }}/current"
    release_id: "{{ lookup('env', 'GITHUB_RUN_ID') | default(lookup('pipe', 'date +%Y%m%d%H%M%S'), true) }}"
    release_path: "{{ releases_dir }}/{{ release_id }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Java
      apt:
        name: openjdk-11-jdk
        state: present

    - name: Ensure base application directory exists
      file:
        path: "{{ app_base }}"
        state: directory
        mode: '0755'

    - name: Ensure releases directory exists
      file:
        path: "{{ releases_dir }}"
        state: directory
        mode: '0755'

    - name: Create release directory
      file:
        path: "{{ release_path }}"
        state: directory
        mode: '0755'

    - name: Create deployment marker file
      copy:
        content: "Release {{ release_id }} deployed via GitHub Actions\n"
        dest: "{{ release_path }}/deployed.txt"

    - name: Update current symlink to new release
      file:
        src: "{{ release_path }}"
        dest: "{{ current_path }}"
        state: link
        force: yes

    - name: Create deployment marker file
      copy:
        content: "Release {{ release_id }} deployed via GitHub Actions\n"
        dest: "{{ release_path }}/deployed.txt"
