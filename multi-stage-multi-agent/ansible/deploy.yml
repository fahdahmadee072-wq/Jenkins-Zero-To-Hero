- name: Deploy HelloWorld app (Production-grade CD)
  hosts: app
  become: yes

  vars:
    app_base: /opt/hello
    releases_dir: "{{ app_base }}/releases"
    current_path: "{{ app_base }}/current"
    release_id: "{{ lookup('env', 'GITHUB_RUN_ID') | default(lookup('pipe', 'date +%Y%m%d%H%M%S'), true) }}"
    release_path: "{{ releases_dir }}/{{ release_id }}"

  tasks:
    - block:

        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install Java
          apt:
            name: openjdk-11-jdk
            state: present

        - name: Ensure base application directory exists
          file:
            path: "{{ app_base }}"
            state: directory
            mode: '0755'

        - name: Ensure releases directory exists
          file:
            path: "{{ releases_dir }}"
            state: directory
            mode: '0755'

        - name: Create release directory
          file:
            path: "{{ release_path }}"
            state: directory
            mode: '0755'

        - name: Create deployment marker file
          copy:
            content: "Release {{ release_id }} deployed via GitHub Actions\n"
            dest: "{{ release_path }}/deployed.txt"

        - name: Update current symlink to new release
          file:
            src: "{{ release_path }}"
            dest: "{{ current_path }}"
            state: link
            force: yes

        # üîç HEALTH CHECKS

        - name: Check deployment marker exists
          stat:
            path: "{{ current_path }}/deployed.txt"
          register: deployment_file

        - name: Fail if deployment marker missing
          fail:
            msg: "Health check failed: deployed.txt missing"
          when: not deployment_file.stat.exists

        - name: Verify deployed release ID
          shell: cat {{ current_path }}/deployed.txt
          register: deployed_content

        - name: Fail if wrong release is active
          fail:
            msg: "Health check failed: current does not point to latest release"
          when: release_id not in deployed_content.stdout

      rescue:

        - name: Roll back to previous release
          shell: |
            PREV_RELEASE=$(ls -dt {{ releases_dir }}/* | sed -n '2p')
            if [ -n "$PREV_RELEASE" ]; then
              ln -sfn "$PREV_RELEASE" "{{ current_path }}"
            fi

        - name: Fail deployment after rollback
          fail:
            msg: "Deployment failed and was rolled back to previous release"

