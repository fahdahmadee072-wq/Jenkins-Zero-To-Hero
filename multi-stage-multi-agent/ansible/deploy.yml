- name: Deploy HelloWorld app (Versioned + Health Check)
  hosts: app
  become: yes

  vars:
    app_base: /opt/hello
    releases_dir: "{{ app_base }}/releases"
    current_path: "{{ app_base }}/current"
    release_id: "{{ lookup('env', 'GITHUB_RUN_ID') | default(lookup('pipe', 'date +%Y%m%d%H%M%S'), true) }}"
    release_path: "{{ releases_dir }}/{{ release_id }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Java
      apt:
        name: openjdk-11-jdk
        state: present

    - name: Ensure base application directory exists
      file:
        path: "{{ app_base }}"
        state: directory
        mode: '0755'

    - name: Ensure releases directory exists
      file:
        path: "{{ releases_dir }}"
        state: directory
        mode: '0755'

    - name: Create release directory
      file:
        path: "{{ release_path }}"
        state: directory
        mode: '0755'

    - name: Create deployment marker file
      copy:
        content: "Release {{ release_id }} deployed via GitHub Actions\n"
        dest: "{{ release_path }}/deployed.txt"

    - name: Update current symlink to new release
      file:
        src: "{{ release_path }}"
        dest: "{{ current_path }}"
        state: link
        force: yes

    # üîç HEALTH CHECK STARTS HERE

    - name: Check that current deployment marker exists
      stat:
        path: "{{ current_path }}/deployed.txt"
      register: deployment_file

    - name: Fail if deployment marker is missing
      fail:
        msg: "Health check failed: deployed.txt not found in current release"
      when: not deployment_file.stat.exists

    - name: Verify deployed release ID
      shell: cat {{ current_path }}/deployed.txt
      register: deployed_content

    - name: Fail if release ID does not match
      fail:
        msg: "Health check failed: current release does not match deployed release"
      when: release_id not in deployed_content.stdout

